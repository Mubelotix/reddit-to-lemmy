// {"operationName":"SubscribedSubredditsCount","variables":{"first":5000},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"b1bbea66ca4ae9e4bbe444aff2a09bc3a1e4309c06df971c84f98e65b66baaec"}}}
// 
// {"data":{"identity":{"subscribedSubreddits":{"edges":[{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}},{"node":{"__typename":"Subreddit"}}]}}}}

use std::cmp::min;
use actix_web::{web::Json, HttpRequest, HttpResponse, ResponseError};
use lemmy_client::{lemmy_api_common::LemmyErrorType, LemmyRequest};
use serde::Deserialize;
use serde_json::json;
use crate::{get_lemmy_client, GraphQlRequest};
use log::{debug, trace};
use GetSubscribedCountError::*;

#[derive(Debug)]
pub enum GetSubscribedCountError {
    Authentication,
    GetSite(LemmyErrorType),
    MissingUser,
}

impl std::fmt::Display for GetSubscribedCountError {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            Authentication => write!(f, "Authentication error"),
            GetSite(e) => write!(f, "Error getting site: {e}"),
            MissingUser => write!(f, "Missing user"),
        }
    }
}

impl ResponseError for GetSubscribedCountError {
    fn status_code(&self) -> awc::http::StatusCode {
        eprintln!("GetSubscribedCountError: {self}");
        awc::http::StatusCode::INTERNAL_SERVER_ERROR
    }
}

#[derive(Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct GetSubscribedCountVariables {
    first: usize
}

pub async fn get_subscribed_count(request: HttpRequest, body: Json<GraphQlRequest<GetSubscribedCountVariables>>) -> Result<HttpResponse, GetSubscribedCountError> {
    debug!("get_subscribed_count");

    let (jwt, client) = get_lemmy_client(&request).ok_or(Authentication)?;

    let posts = client.get_site(LemmyRequest { body: (), jwt: Some(jwt.clone()) }).await.map_err(GetSite)?;
    let my_user = posts.my_user.ok_or(MissingUser)?;
    let count = min(my_user.follows.len(), body.variables.first);

    let rep = json! {{
        "data": {
            "identity": {
                "subscribedSubreddits": {
                    "edges": (0..count).map(|_community| json! {{
                        "node": {
                            "__typename": "Subreddit",
                        }
                    }}).collect::<Vec<_>>()
                }
            }
        }
    }};
    
    trace!("get_subscribed_count response: {count} repetitions of pattern");
    Ok(HttpResponse::Ok().json(rep))
}

