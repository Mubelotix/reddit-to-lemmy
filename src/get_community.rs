// {"operationName":"SubredditStructuredStyle","variables":{"subredditName":"oddlyspecific","includeWidgets":true,"includeMediaAuth":false,"includeExtendedVideoAsset":false},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"3fc9ae9d246e1bf788d514c4bdd24363458723cfc3af91be594ede7d1f258511"}}}
//
// {"data":{"subredditInfoByName":{"__typename":"Subreddit","id":"t5_2wjlc","styles":{"__typename":"SubredditStyles","icon":"https://styles.redditmedia.com/t5_2wjlc/styles/communityIcon_dyrr6hglcrnc1.png?width=256\u0026height=256\u0026frame=1\u0026auto=webp\u0026crop=256:256,smart\u0026s=e6cc833562424a62abc2ae0ae87bb30128033f1a","primaryColor":null,"bannerBackgroundImage":null,"bannerBackgroundColor":null,"bannerBackgroundImagePosition":null,"mobileBannerImage":null,"postDownvoteIconActive":"https://styles.redditmedia.com/t5_2wjlc/styles/postDownvoteIconActive_lnn60d6pgjlc1.png?width=20\u0026height=20\u0026frame=1\u0026auto=webp\u0026crop=20:20,smart\u0026s=d64e077ab71dae13efb8d28eea24db59dea9a965","postDownvoteIconInactive":"https://styles.redditmedia.com/t5_2wjlc/styles/postDownvoteIconInactive_ln6g28wogjlc1.png?width=20\u0026height=20\u0026frame=1\u0026auto=webp\u0026crop=20:20,smart\u0026s=f6305aa657c6d8ef573e4ffb5edae1fe479c9f2c","postDownvoteCountColor":"#FFB000","postUpvoteIconActive":"https://styles.redditmedia.com/t5_2wjlc/styles/postUpvoteIconActive_6iflzi0ogjlc1.png?width=20\u0026height=20\u0026frame=1\u0026auto=webp\u0026crop=20:20,smart\u0026s=4327e891304b42ae8bd85712ecc5fc9e7ef3d657","postUpvoteIconInactive":"https://styles.redditmedia.com/t5_2wjlc/styles/postUpvoteIconInactive_9jt1asgngjlc1.png?width=20\u0026height=20\u0026frame=1\u0026auto=webp\u0026crop=20:20,smart\u0026s=7e2ed1e9273973747a8721168c897b41c23ebb99","postUpvoteCountColor":"#FFB000","postPlaceholderImage":null,"postPlaceholderImagePosition":null,"postVoteIcons":"CUSTOM","highlightColor":null,"sidebarWidgetBackgroundColor":null,"sidebarWidgetHeaderColor":null},"widgets":{"orderedTopbarWidgets":[],"orderedSidebarWidgets":[{"__typename":"SubredditRulesWidget","id":"widget_rules-2wjlc","shortName":"Subreddit Rules","display":"compact"},{"__typename":"IdCardWidget","id":"widget_id-card-2wjlc","shortName":"Community Details","currentlyViewingText":"","subscribersText":""},{"__typename":"ModeratorWidget","id":"widget_moderators-2wjlc","shortName":null,"moderators":[{"redditor":{"name":"UndeadCaesar"},"flair":null},{"redditor":{"name":"MAGIC_EYE_BOT"},"flair":null},{"redditor":{"name":"RepostSleuthBot"},"flair":null},{"redditor":{"name":"ProjectSnipe"},"flair":null},{"redditor":{"name":"wolf805"},"flair":null}]}]},"moderatorsInfo":{"edges":[{"node":{"id":"t2_3bbuf"}},{"node":{"id":"t2_2717bc9o"}},{"node":{"id":"t2_33p62kyo"}},{"node":{"id":"t2_hbk0k"}},{"node":{"id":"t2_eth9u"}}]},"rules":[{"__typename":"SubredditRule","id":"62595227-d606-4c99-aa12-b3da14d7ee0a","name":"Frequent repost.","violationReason":"This is a recent/frequent repost.","priority":0,"content":{"__typename":"Content","richtext":"{\"document\":[{\"c\":[{\"e\":\"text\",\"t\":\"This post has been flagged as a recent repost or a repost from the very frequent repost list at the top of the sub.\"}],\"e\":\"par\"}]}","richtextMedia":[],"typeHint":null,"html":"\u003cp\u003eThis post has been flagged as a recent repost or a repost from the very frequent repost list at the top of the sub.\u003c/p\u003e","markdown":"This post has been flagged as a recent repost or a repost from the very frequent repost list at the top of the sub."}},{"__typename":"SubredditRule","id":"ffacfe8c-44ec-4f02-a74d-611af8ec0d4c","name":"Targeted harassment.","violationReason":"This post contains targeted harassment against a member or larger group.","priority":1,"content":{"__typename":"Content","richtext":"{\"document\":[{\"c\":[{\"e\":\"text\",\"t\":\"No harassment will be tolerated in \"},{\"e\":\"r/\",\"l\":true,\"t\":\"oddlyspecific\"},{\"e\":\"text\",\"t\":\".\"}],\"e\":\"par\"}]}","richtextMedia":[],"typeHint":null,"html":"\u003cp\u003eNo harassment will be tolerated in /r/oddlyspecific.\u003c/p\u003e","markdown":"No harassment will be tolerated in /r/oddlyspecific."}},{"__typename":"SubredditRule","id":"1094011e-a484-4e8f-8d4e-2823bfbb24de","name":"Zero-effort title.","violationReason":"This post has a zero-effort title.","priority":2,"content":{"__typename":"Content","richtext":"{\"document\":[{\"c\":[{\"e\":\"text\",\"t\":\"All posts require titles that relate to the content of the post. No click-bait or \\\"haha so true\\\" titles are allowed.\"}],\"e\":\"par\"}]}","richtextMedia":[],"typeHint":null,"html":"\u003cp\u003eAll posts require titles that relate to the content of the post. No click-bait or \"haha so true\" titles are allowed.\u003c/p\u003e","markdown":"All posts require titles that relate to the content of the post. No click-bait or \"haha so true\" titles are allowed."}},{"__typename":"SubredditRule","id":"ff04de09-031b-4a05-a881-b470f297d3eb","name":"Shock/gore/violent sexuality.","violationReason":"This post contains shock/gore/violent sexuality.","priority":3,"content":{"__typename":"Content","richtext":"{\"document\":[{\"c\":[{\"e\":\"text\",\"t\":\"This community does not accept posts containing shock/gore/violent sexuality.\"}],\"e\":\"par\"}]}","richtextMedia":[],"typeHint":null,"html":"\u003cp\u003eThis community does not accept posts containing shock/gore/violent sexuality.\u003c/p\u003e","markdown":"This community does not accept posts containing shock/gore/violent sexuality."}},{"__typename":"SubredditRule","id":"45e6d8d1-8892-4c2a-88e7-2bdce729358a","name":"Be nice.","violationReason":"Be nice.","priority":4,"content":{"__typename":"Content","richtext":"{\"document\":[{\"c\":[{\"e\":\"text\",\"t\":\"Please remember the human and keep conversations in the comments respectful. Refusal to comply will be subject to a ban.\"}],\"e\":\"par\"}]}","richtextMedia":[],"typeHint":null,"html":"\u003cp\u003ePlease remember the human and keep conversations in the comments respectful. Refusal to comply will be subject to a ban.\u003c/p\u003e","markdown":"Please remember the human and keep conversations in the comments respectful. Refusal to comply will be subject to a ban."}},{"__typename":"SubredditRule","id":"ba13ad50-4f93-4d72-a997-b0f342c50ba6","name":"Nothing overtly political","violationReason":"Submissions must derive humor from the specificity of the subject, not from their political meaning","priority":5,"content":{"__typename":"Content","richtext":null,"richtextMedia":null,"typeHint":null,"html":"","markdown":""}}]}}}


// {"operationName":"SubredditStructuredStyle","variables":{"subredditName":"u_TeamAsana","includeWidgets":true,"includeMediaAuth":false,"includeExtendedVideoAsset":false},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"3fc9ae9d246e1bf788d514c4bdd24363458723cfc3af91be594ede7d1f258511"}}}
// 
// {"data":{"subredditInfoByName":null}}


use actix_web::{web::Json, HttpRequest, HttpResponse, ResponseError};
use lemmy_client::{lemmy_api_common::{community::GetCommunity, LemmyErrorType}, LemmyRequest};
use log::{debug, trace};
use serde::Deserialize;
use serde_json::json;
use crate::{get_lemmy_client, GraphQlRequest, HackTraitCommunity, HackTraitPerson};
use GetCommunityError::*;

#[derive(Debug)]
pub enum GetCommunityError {
    Authentication,
    GetCommunity(LemmyErrorType),
}

impl std::fmt::Display for GetCommunityError {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            Authentication => write!(f, "Authentication error"),
            GetCommunity(e) => write!(f, "GetCommunity error: {e}"),
        }
    }
}

impl ResponseError for GetCommunityError {
    fn status_code(&self) -> awc::http::StatusCode {
        eprintln!("GetCommunityError: {self}");
        awc::http::StatusCode::INTERNAL_SERVER_ERROR
    }
}

#[derive(Deserialize, Debug)]
#[serde(rename_all = "camelCase")]
pub struct GetCommunityVariables {
    subreddit_name: String
}

pub async fn get_community(request: HttpRequest, body: Json<GraphQlRequest<GetCommunityVariables>>) -> Result<HttpResponse, GetCommunityError> {
    debug!("get_community: {:?}", body.variables);

    if body.variables.subreddit_name.starts_with("u_") {
        return Ok(HttpResponse::Ok().json(json! {{
            "data": {
                "subredditInfoByName": null
            }
        }}));
    }
    
    let (jwt, client) = get_lemmy_client(&request).ok_or(Authentication)?;

    let details = client.get_community(LemmyRequest { body: GetCommunity {
        name: Some(body.variables.subreddit_name.clone()),
        ..Default::default()
    }, jwt: Some(jwt.clone()) }).await.map_err(GetCommunity)?;

    let rep = json! {{
        "data": {
            "subredditInfoByName": {
                "__typename": "Subreddit",
                "id": details.community_view.community.reddit_id(),
                "styles": {
                    "__typename": "SubredditStyles",
                    "icon": details.community_view.community.icon,
                    "primaryColor": null,
                    "bannerBackgroundImage": null,
                    "bannerBackgroundColor": null,
                    "bannerBackgroundImagePosition": null,
                    "mobileBannerImage": null,
                    "postDownvoteIconActive": null,
                    "postDownvoteIconInactive": null,
                    "postDownvoteCountColor": 	null,
                    "postUpvoteIconActive": null,
                    "postUpvoteIconInactive": null,
                    "postUpvoteCountColor": null,
                    "postPlaceholderImage": null,
                    "postPlaceholderImagePosition": null,
                    "postVoteIcons": "DEFAULT",
                    "highlightColor": null,
                    "sidebarWidgetBackgroundColor": null,
                    "sidebarWidgetHeaderColor": null,
                },
                "widgets": {
                    "orderedTopbarWidgets": [],
                    "orderedSidebarWidgets": [
                        {
                            "__typename": "SubredditRulesWidget",
                            "id": format!("widget_rules-{}", &details.community_view.community.reddit_id()[3..]),
                            "shortName": "Subreddit Rules",
                            "display": "compact",
                        },
                        {
                            "__typename": "IdCardWidget",
                            "id": format!("widget_id-card-{}", &details.community_view.community.reddit_id()[3..]),
                            "shortName": "Community Details",
                            "currentlyViewingText": "",
                            "subscribersText": "",
                        },
                        {
                            "__typename": "ModeratorWidget",
                            "id": format!("widget_moderators-{}", &details.community_view.community.reddit_id()[3..]),
                            "shortName": null,
                            "moderators": details.moderators.iter().map(|view| {
                                json! {{
                                    "redditor": {
                                        "name": view.moderator.display_name.as_ref().unwrap_or(&view.moderator.name),
                                    },
                                    "flair": null
                                }}
                            }).collect::<Vec<_>>()
                        }
                    ]
                },
                "moderatorsInfo": {
                    "edges": details.moderators.iter().map(|view| {
                        json! {{
                            "node": {
                                "id": view.moderator.reddit_id(),
                            }
                        }}
                    }).collect::<Vec<_>>()
                },
                "rules": []
            },
        }
    }};

    trace!("get_community: {}", serde_json::to_string(&rep).unwrap_or_default());
    Ok(HttpResponse::Ok().json(rep))
}

